Модуль предназначен для взаимодействия с OBD-II сканерами по Bluetooth или Wi-Fi, получения диагностических данных, обработки команд, поддержки потоковых (Live) данных и расширяемости.

OBD-II (On-Board Diagnostics II) — это стандарт, используемый для диагностики и сбора данных с электронных блоков управления автомобилем (ECU). Протокол позволяет:
•    Читать текущие данные с датчиков.
•    Получать диагностические коды неисправностей (DTC).
•    Сбрасывать коды ошибок.
•    Получать VIN, статус работы компонентов и др.


1. Режимы работы OBD-II (Service 01 − 01−0A)

OBD-команды (01-0A) - это "язык общения" с ЭБУ автомобиля

OBD-II поддерживает 10 режимов диагностики (сервисов):

Основные режимы:

$01 - Получение текущих данных
$02 - Получение замороженных данных
$03 - Получение диагностических кодов неисправностей (DTC)
$04 - Очистка DTC и сохраненной информации
$05 - Получение результатов тестов кислородных датчиков
$06 - Результаты тестов непостоянного мониторинга
$07 - Получение диагностических кодов неисправностей во время движения
$08 - Управление компонентами
$09 - Получение информации о транспортном средстве
$0A - Получение постоянных диагностических кодов неисправностей


2. Формат команд OBD-II

Команды OBD-II отправляются в шестнадцатеричном формате:

[Режим] [PID] [Доп. параметры]

Пример: 01 0C - запрос оборотов двигателя (режим 01, PID 0C)



3. Парсинг ответов OBD-II

Формат ответа: [Длина ответа] [Режим + 0x40] [PID] [Данные...] [Контрольная сумма]

Пример ответа на команду 01 0C: 41 0C 1B F8

Где:

41 = режим 01 + 0x40
0C - запрошенный PID
1B F8 - данные



4. Стандартные PID (Parameter IDs)


PID    Описание                          Формула    Единицы измерения
00    Поддерживаемые PIDs 01-20             -         Битовая маска
01    Статус после проверки                 -          Битовая маска
0C    Обороты двигателя                 (256*A+B)/4       RPM
0D    Скорость автомобиля                   A             km/h
05    Температура охлаждающей жидкости     A-40             °C
0A    Давление топлива                      3*A             kPa
0F    Температура впускного воздуха         A-40            °C
11    Положение дроссельной заслонки       100*A/255         %
1F    Время работы двигателя               256*A+B         секунды



5. Взаимодействие через Bluetooth (ELM327)

Профили Bluetooth:

SPP (Serial Port Profile) - эмулирует последовательное соединение
Сервисы и характеристики:

Сервис последовательного порта (UUID: 00001101-0000-1000-8000-00805F9B34FB)
Характеристика TX (от устройства к клиенту)
Характеристика RX (от клиента к устройству)
Протокол обмена:

Установить соединение с адаптером ELM327

AT-команды - это "язык общения" с самим OBD-адаптером (ELM327 или аналогом)

▸ Управляют работой адаптера
▸ Настраивают параметры связи
▸ Не зависят от автомобиля

Отправить команды AT для настройки:
    ATZ - сброс
    ATE0 - отключение эха
    ATL0 - отключение перевода строки
    ATH1 - включение заголовков в ответах
    
AT-команды (Attention Commands) - это набор инструкций для конфигурации и управления OBD-II адаптерами. Большинство Bluetooth/Wi-Fi адаптеров используют чип ELM327 или его клоны, поддерживающие стандартный набор AT-команд.

Базовые AT-команды:


Команда                Описание                                     Пример ответа
ATZ                    Сброс адаптера (перезагрузка)                ELM327 v1.5
ATI                     Идентификация адаптера                      ELM327 v1.5
AT@1                    Показать Device Description                 OBDII-ELM327 v1.5
AT@2                    Показать идентификатор устройства              SC123456
ATH1                    Включить заголовки в ответах                    OK
ATH0                    Отключить заголовки                             OK
ATE1                    Включить эхо (адаптер дублирует ввод)           OK
ATE0                    Отключить эхо (рекомендуется)                   OK
ATL1                    Включить перевод строки                         OK
ATL0                    Отключить перевод строки                        OK
ATSP0                   Автовыбор протокола                             OK
ATDP                    Показать текущий протокол                   AUTO, ISO 15765-4
ATDPN                   Показать номер протокола                          6


Отправка OBD команд:
01 0C\r - запрос оборотов двигателя


6. Безопасность и ограничения

Некоторые команды могут влиять на работу автомобиля (особенно режим $08)
Чтение DTC может потребовать специальных прав
Очистка DTC ($04) сбрасывает адаптацию двигателя




Сброс Check Engine (очистка диагностических кодов неисправностей - DTC)

Для сброса Check Engine через OBD-II используются следующие методы:

1. Стандартный метод через режим $04

Команда: 04

Отправьте команду очистки:

ATZ        // Сброс адаптера
ATE0       // Отключение эха
04         // Команда очистки DTC


Команды 01 00, 02 00, …, 0A 00 возвращают битовую маску поддерживаемых PID’ов (Parameter IDs) в соответствующем режиме. Например:
    •    01 00 — поддерживаемые PID’ы от 01 до 20
    •    01 20 — PID’ы от 21 до 40

